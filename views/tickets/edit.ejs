<% layout('layout') %>
<% title = 'Dashboard' %>
<%# This content will be injected into the layout file %>

<h1 class="h3 mb-4 text-gray-800">Edit Ticket</h1>

<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">Ticket Details</h6>
    </div>
    <div class="card-body">
        <form action="/admin/tickets/<%= ticket._id %>?_method=PUT" method="POST">
            <div class="form-group">
                <label for="ticket_type">Ticket Type:</label>
                <select class="form-control" id="ticket_type" name="ticket_type" required>
                    <option value="">-- Select Ticket Type --</option>
                    <% ticketTypes.forEach(type => { %>
                         <%# Check if ticket.ticket_type exists and matches the current type's ID %>
                        <option value="<%= type._id %>" <%= ticket.ticket_type && ticket.ticket_type.equals(type._id) ? 'selected' : '' %>><%= type.name %> (<%= type.price.toFixed(2) %>)</option>
                    <% }) %>
                </select>
            </div>
             <div class="form-group">
                <label for="ticket_code">Ticket Code:</label>
                <input type="text" class="form-control" id="ticket_code" name="ticket_code" value="<%= ticket.ticket_code %>" required>
            </div>
            <div class="form-group">
                <label for="purchaser_name">Purchaser Name:</label>
                <input type="text" class="form-control" id="purchaser_name" name="purchaser_name" value="<%= ticket.purchaser_name %>" required>
            </div>
            <div class="form-group">
                <label for="purchaser_email">Purchaser Email:</label>
                <input type="email" class="form-control" id="purchaser_email" name="purchaser_email" value="<%= ticket.purchaser_email %>" required>
            </div>
            <div class="form-group">
                <label for="purchaser_phone">Purchaser Phone:</label>
                <input type="text" class="form-control" id="purchaser_phone" name="purchaser_phone" value="<%= ticket.purchaser_phone %>" required>
            </div>
             <div class="form-group">
                <label for="status">Status:</label>
                <select class="form-control" id="status" name="status" required>
                    <option value="unused" <%= ticket.status === 'unused' ? 'selected' : '' %>>Unused</option>
                    <option value="used" <%= ticket.status === 'used' ? 'selected' : '' %>>Used</option>
                    <option value="cancelled" <%= ticket.status === 'cancelled' ? 'selected' : '' %>>Cancelled</option>
                </select>
            </div>
             <div class="form-group">
                <label for="payment_status">Payment Status:</label> <%# Added field %>
                <select class="form-control" id="payment_status" name="payment_status" required>
                     <option value="">-- Select Payment Status --</option>
                    <% paymentStatuses.forEach(status => { %>
                        <option value="<%= status %>" <%= ticket.payment_status === status ? 'selected' : '' %>><%= status.charAt(0).toUpperCase() + status.slice(1) %></option> <%# Capitalize first letter %>
                    <% }) %>
                </select>
            </div>
             <div class="form-group">
                <label for="used_at">Used At (Optional):</label>
                 <%# Format date for input type="datetime-local" %>
                <input type="datetime-local" class="form-control" id="used_at" name="used_at" value="<%= used_at_formatted %>">
            </div>

            <button type="submit" class="btn btn-primary">Update Ticket</button>
            <a href="/admin/tickets" class="btn btn-secondary">Cancel</a>
        </form>

        <hr> <%# Separator for delete form %>

        <%# Separate form for Delete action %>
        <form action="/admin/tickets/<%= ticket._id %>?_method=DELETE" method="POST" class="d-inline">
            <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this ticket?')">Delete Ticket</button>
        </form>
    </div>
</div>

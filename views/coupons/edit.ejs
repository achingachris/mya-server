<% layout('layout') %>
<% title = 'Dashboard' %>
<h1 class="h3 mb-4 text-gray-800">Edit Coupon</h1>

<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">Coupon Details</h6>
    </div>
    <div class="card-body">
        <form action="/admin/coupons/<%= coupon._id %>?_method=PUT" method="POST">
            <div class="form-group">
                <label for="code">Coupon Code:</label>
                <input type="text" class="form-control" id="code" name="code" value="<%= coupon.code %>" required>
            </div>
            <div class="form-group">
                <label for="type">Discount Type:</label>
                <select class="form-control" id="type" name="type" required>
                    <option value="">-- Select Type --</option>
                    <option value="percentage" <%= coupon.type === 'percentage' ? 'selected' : '' %>>Percentage (%)</option>
                    <option value="fixed" <%= coupon.type === 'fixed' ? 'selected' : '' %>>Fixed Amount</option>
                </select>
            </div>
            <div class="form-group">
                <label for="value">Discount Value:</label>
                <input type="number" class="form-control" id="value" name="value" step="0.01" value="<%= coupon.value %>" required>
            </div>
             <div class="form-group">
                <label for="max_uses">Maximum Uses (Leave blank for unlimited):</label>
                <input type="number" class="form-control" id="max_uses" name="max_uses" value="<%= coupon.max_uses %>">
            </div>
             <div class="form-group">
                <label for="uses_count">Uses Count (Read Only):</label>
                <input type="number" class="form-control" id="uses_count" name="uses_count" value="<%= coupon.uses_count %>" readonly>
            </div>
            <div class="form-group">
                <label for="expiry_date">Expiry Date:</label>
                 <%# Use the formatted date passed from the route %>
                <input type="date" class="form-control" id="expiry_date" name="expiry_date" value="<%= expiry_date_formatted %>" required>
            </div>
             <div class="form-group">
                <label for="applicable_ticket_type">Applicable Ticket Type (Optional):</label>
                <select class="form-control" id="applicable_ticket_type" name="applicable_ticket_type">
                    <option value="">-- Any Ticket Type --</option>
                    <% ticketTypes.forEach(type => { %>
                         <%# Check if coupon.applicable_ticket_type exists and matches the current type's ID %>
                        <option value="<%= type._id %>" <%= coupon.applicable_ticket_type && coupon.applicable_ticket_type.equals(type._id) ? 'selected' : '' %>><%= type.name %></option>
                    <% }) %>
                </select>
                 <small class="form-text text-muted">Select a ticket type if this coupon only applies to that specific type.</small>
            </div>
             <div class="form-group">
                <label for="status">Status:</label>
                <select class="form-control" id="status" name="status" required>
                    <option value="active" <%= coupon.status === 'active' ? 'selected' : '' %>>Active</option>
                    <option value="inactive" <%= coupon.status === 'inactive' ? 'selected' : '' %>>Inactive</option>
                    <option value="expired" <%= coupon.status === 'expired' ? 'selected' : '' %>>Expired</option>
                </select>
            </div>
             <div class="form-group">
                <label for="description">Description (Optional):</label>
                <textarea class="form-control" id="description" name="description" rows="3"><%= coupon.description %></textarea>
            </div>

            <button type="submit" class="btn btn-primary">Update Coupon</button>
            <a href="/admin/coupons" class="btn btn-secondary">Cancel</a>
        </form>

        <hr> <%# Separator for delete form %>

        <%# Separate form for Delete action %>
        <form action="/admin/coupons/<%= coupon._id %>?_method=DELETE" method="POST" class="d-inline">
            <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this coupon?')">Delete Coupon</button>
        </form>
    </div>
</div>
